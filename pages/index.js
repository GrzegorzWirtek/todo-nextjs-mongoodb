import Head from 'next/head';
import styles from '@/styles/Home.module.css';
import { connectMongoDB } from '@/libs/mongodb/Connect';
import TaskModel from '@/libs/mongodb/TaskModel';
import Task from '@/components/Task';
import { useState } from 'react';
import deleteTask from '@/utils/deleteTask';
import getTasks from '@/utils/getTasks';
import addTask from '@/utils/addTask';
import AddForm from '@/components/AddForm';

export default function Home({ tasksData }) {
	const [tasks, setTasks] = useState(tasksData);

	const handleDelete = async (_id) => {
		const res = await deleteTask(_id);
		if (!res) return;
		const tasks = await getTasks();
		setTasks(tasks);
	};

	const addNewTask = async (taskData) => {
		const res = await addTask(taskData);
		if (!res) return;
		const tasks = await getTasks();
		setTasks(tasks);
	};

	return (
		<>
			<Head>
				<title>Todo Next and Mongoose app</title>
				<meta
					name='description'
					content='A todo application that uses the MngoDB Atlas database, generated by create next app'
				/>
				<meta name='viewport' content='width=device-width, initial-scale=1' />
				<link rel='icon' href='/favicon.ico' />
			</Head>
			<main className={styles.main}>
				<h1>This is home</h1>
				<AddForm addNewTask={addNewTask} />
				{tasks &&
					tasks.map((task) => (
						<Task key={task._id} data={task} handleDelete={handleDelete} />
					))}
			</main>
		</>
	);
}

export async function getServerSideProps() {
	await connectMongoDB();
	const data = await TaskModel.find();
	const tasksData = JSON.parse(JSON.stringify(data));

	return {
		props: {
			tasksData,
		},
	};
}
